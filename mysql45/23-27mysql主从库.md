<!--
 * @Author: zzzzztw
 * @Date: 2023-05-10 13:30:14
 * @LastEditors: Do not edit
 * @LastEditTime: 2023-05-10 18:53:41
 * @FilePath: /myLearning/mysql45/23-27mysql主从库.md
-->
# 23mysql怎么保证主从一致

- 通过主库向从库发送binlog来保持主从一致，主库在relog log prepare状态后，写好了binlog，就发送给从库，从库接收后写入一个中转日志relay log，然后mysql开始解析日志，同步记录。
- redo log 与binlog 有一个XID字段来对应，拿着XID去另一个日志找有没有对应的记录。

### binlog 三种格式对比

- row格式， statement格式， mixed格式
- statement：记录着具体的sql语句，但如果sql语句中有多个索引，不同库执行时可能优化后选择的索引不同，导致不同的结果
- row：记录着在哪个库中执行，一个哈希值，修改的具体信息，还有记录着修改主键的id，都按主键来修改所以主从库修改结果一致
- mixed格式：如果按statement可能导致主从不一致，全row导致记录全部信息很占内存（statement只记录一个sql语句），所以mixed格式就是会自动判断当前sql语句是否会引起主从不一致，自动选择row或statement

# 24 mysql怎么保证高可用

1. 主从复制可以保证最终一致性，但过程中不能保证，因为有主从延迟
2. 主从延迟的主要来源三点：1. 从库性能太差读中转relay日志太慢 2. 从库提供读的服务，压力太大，导致执行读日志太慢 3. 主库执行了大事务，例如一个sql语句执行10分钟，发给从库后，从库执行，此时主从库之间的数据大概差了10分钟延迟。 


## 25 备库为什么会延迟几个小时

当主库并发度很高的时候，相当于数据进入流量很大，从库读取压力很大，导致主从延迟很大，甚至永远赶不上主库。

## 26 主库出现问题了，切换从库

略了

