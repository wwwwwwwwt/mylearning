<!--
 * @Author: zzzzztw
 * @Date: 2023-04-19 20:02:51
 * @LastEditors: Do not edit
 * @LastEditTime: 2023-04-19 21:38:14
 * @FilePath: /myLearning/mysql45/13表数据删除一半表文件大小不变.md
-->
# mysql表数据删掉一半，表文件大小不变？

1. 表数据可以放在共享空间内，也可放在当度的文件内.ibd结尾，如果放在共享空间内，就算使用drop table也不会收回空间。放在单独文件，系统就会直接删除这个文件，从而释放空间，由参数 innodb_file_per_table决定 on 就是单独文件。

2. 删除整个表可以drop table回收表空间，truncate = drop + create
   
## 如果删除某些行，也可能会出现删除数据，空间没回收的情况

1. 知识点：删除表中的数据其实是将这个数据B+树上的位置标记为已删除 + 可以复用下次在这个区间插入就可以复用这个位置。如果是整个数据页被删除，那么这个页都可以被复用成任何区间的数据，相当于全新。所以删除数据不是彻底删除，而是标记+更新。
2. 不只是删除数据可能会造成数据库的空洞，插入时如果随即插入导致数据页分裂了，也会导致原先位置产生了空洞，没有使用
3. 根据上面这两种导致的数据空洞，可以使用重建表的方式缩小空洞，即将数据按主键索引自然增长的顺序再重建一边表。

## 重建表的流程

```sql
alter table t engine=innodb,ALGORITHM=implace;

```

1. 建立临时文件，扫描表A所有数据页；
2. 生成B+树存储到临时文件中
3. 生成临时文件过程中，对A的操作记录放在日志文件中（row log）
4. 生成文件后，将日志内容应用到临时文件内
5. 使用临时文件替换表A的数据文件

* 注意：alter语句执行时会拿到MDL写锁，但拷贝时就退化为读锁了。mdl读锁不影响数据增删改，但会阻止其他线程进行表结构修改。
* 因为复制了几乎一模一样的表，所以重建表的时候需要用到两倍的表的大小的空间。