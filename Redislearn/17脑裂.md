<!--
 * @Author: zzzzztw
 * @Date: 2023-05-13 13:52:48
 * @LastEditors: Do not edit
 * @LastEditTime: 2023-05-13 15:00:28
 * @FilePath: /myLearning/Redislearn/17脑裂和分布式集群方案.md
-->
# 脑裂

1. 为什么会发生脑裂：主库由于cpu占用太大，迟迟没回复哨兵节点消息，被判定下线，因此发生假故障，再换主的过程中，这个主库又上线了，客户端还和这个主库进行了数据的更新，等到换主完，这个库成了从库，接受主库发来的RDB文件之后，先要把自己数据清空再接受，因此客户端在换主过程中发去的消息将丢失。

2. 为啥会发生假故障：
   1.  和主库部署在同一台服务器上的其他程序临时占用了大量资源（例如 CPU 资源），导致主库资源使用受限，短时间内无法响应心跳。其它程序不再使用资源时，主库又恢复正常。
   2.  主库自身遇到了阻塞的情况，例如，处理 bigkey 或是发生内存 swap（你可以复习下第 19 讲中总结的导致实例阻塞的原因），短时间内无法响应心跳，等主库阻塞解除后，又恢复正常的请求处理了。

3. 如何应对脑裂：根据设置限制住库接受客户端消息的设置，1. 主库进行数据同步的最小从库数量，主从库进行数据复制时，从库给主库发送ACK消息的最大延迟。
   1. 把哨兵接受最大ping延迟设为10s， 把接受从库ack为12s，这样，哨兵判定她下线之后，主库就会被限制接收客户端请求，从而无法写入数据，不会造成数据丢失。
   2. 出现问题后主库会觉得和自己通信的节点数量少了，同时ack超过时间就不接受客户端请求了。