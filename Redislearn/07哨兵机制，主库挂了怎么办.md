<!--
 * @Author: zzzzztw
 * @Date: 2023-03-23 15:19:57
 * @LastEditors: Do not edit
 * @LastEditTime: 2023-03-23 18:56:39
 * @FilePath: /cpptest/Redislearn/07哨兵机制，主库挂了怎么办.md
-->
# 07 | 哨兵机制：主库挂了，如何不间断服务？
简单的说结论：当一个主库挂了会由哨兵机制选出新的从库作为主库，选择的期间会使客户端写操作感知到异常，读操作不受影响还是可以从从库中读取，通常解决方案会将客户端的的写操作记录到缓存中，当新主库选举出后，再写入新主库。

## 哨兵机制是实现主从库自动切换的关键机制（sentinel）
哨兵实际上是运行在特殊模式下的reids进程，主从库实例运行时，哨兵也在运行。
1. 基本流程： 监控各个库的在线状态和网络状态，遇到主库下线则选出主库，通知其他从库切换到新主库
* 监控：哨兵运行时会周期性的给所有主从库发送PING命令，检测他们是否运行。如果在规定时间没有回复，就判定其下线
* 选主库：主库挂了就需要从很多个从库内，按一定的规则选出目前最优秀的从库来当作主库。
* 通知：选出主库后，会把新主库的连接信息发给其他从库，让他们执行replicaof命令，和新主库建立连接进行数据复制.

## 如何判断主库下线和到底选哪个从库当作新主库
### 判断下线
* 如果哨兵检测到从库下线，直接可以定义其离线，因为从库对服务影响不大。
* 如果哨兵检测到主库下线，需要进行投票，等待所有哨兵的结果出来，少数服从多数来决定主库是否是下线状态，尽可能避免由于网络原因产生或主库本身压力很大的情况的误判。因为更换主库设计大量的数据复制和主从库之间的通信，应尽量避免误判。
### 在从库中选出新主库
选出新主库进行两步，筛选，打分
* 筛选：哨兵根据从库现在的网络状态和过去一段时间的（从库断连次数）网络状态，筛选出网络稳定的从库。
* 打分：根据 优先级 和主库复制进度 id序号来进行排序，在每一轮中有一个胜出就结束打分，选其当作新主库
  1. 用户可以通过 slave-priority 配置项，给不同的从库设置不同优先级。
  2. 根据每个从库中的slave_repl_offset(代表着记录当前这个库对主库的复制进度)进行打分，进度最快的胜出
  3. id小的打分，前两步骤都一样的情况，id小的当主库。

### 通过哨兵机制，可以实现主从库的自动切换，这是实现服务不间断的关键支撑，同时，我也提到了主从库切换是需要一定时间的。所以，请你考虑下，在这个切换过程中，客户端能否正常地进行请求操作呢？如果想要应用程序不感知服务的中断，还需要哨兵或需要客户端再做些什么吗？


如果不想让业务感知到异常，客户端只能把写失败的请求先缓存起来或写入消息队列中间件中，等哨兵切换完主从后，再把这些写请求发给新的主库，但这种场景只适合对写入请求返回值不敏感的业务，而且还需要业务层做适配，另外主从切换时间过长，也会导致客户端或消息队列中间件缓存写请求过多，切换完成之后重放这些请求的时间变长。

### 哨兵集群中有实例挂了，怎么办，会影响主库状态判断和选主吗？
答：分布式系统中的拜占庭将军问题，简单说结论：存在故障节点时，只要集群中大多数节点状态正常，集群依旧可以对外提供服务。具体推导过程细节很多，大家去查前面的资料了解就好。

### 哨兵集群多数实例达成共识，判断出主库“客观下线”后，由哪个实例来执行主从切换呢？

答：哨兵集群判断出主库“主观下线”后，会选出一个“哨兵领导者”，之后整个过程由它来完成主从切换。

但是如何选出“哨兵领导者”？这个问题也是一个分布式系统中的问题，就是我们经常听说的共识算法，指的是集群中多个节点如何就一个问题达成共识。共识算法有很多种，例如Paxos、Raft，这里哨兵集群采用的类似于Raft的共识算法。