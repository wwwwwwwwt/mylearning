<!--
 * @Author: zzzzztw
 * @Date: 2023-03-23 19:39:23
 * @LastEditors: Do not edit
 * @LastEditTime: 2023-04-18 21:08:39
 * @FilePath: /cpptest/Redislearn/08哨兵集群：哨兵挂了和哨兵leader选举.md
-->
# 哨兵集群原理
1. 基于pub/sub的发布/订阅机制
* 配置哨兵信息：```sentinel monitor <master-name> <ip> <redis-port> <quorum> ```只需要知道主库的ip和端口还有确定主库客观掉线仲裁时所需的赞成票
* 哨兵和主库建立联系后，就可以在上面发布自己的连接信息（ip/端口），也可以在上面订阅消息，获得其他哨兵的连接信息。哨兵通过订阅特定的频道互相发布自己的消息，这样哨兵之间互相就建立的网络通信。
* 哨兵通过发送INFO从主库中得到从库的列表，从而知道从库的IP和端口。  
## 总结
1. 通过在主库特定频道进行pub/sub，哨兵之间建立集群
2. 通过向主库发送INFO，对从库进行监视。
## 客户端需要通过监控了解哨兵进行主从切换的进度到哪里该怎么办？
1. 通过pub/sub机制，客户端可以从哨兵订阅消息，包括各种事件：主库下线/从库重新配置/新主库切换等事件。subscribe + 订阅事件 或者 psubscribe * 订阅所有事件

## 由哪个哨兵执行主从切换
1. 流程 一个哨兵认为主库主观下线了，然后发起投票，其他哨兵进行投票，这个哨兵得到所需赞成票后，立即发起leader选举，并给自己投票，其他哨兵来选举，只有这个哨兵得到票数超过总哨兵数量的一半，才能成为leader进行主从库切换。
2. 所以由以上结论可以发现，只有两个的哨兵集群要想成为leader必须获得2票，如果有一个哨兵实例挂了，这个哨兵集群就无法选举成leader进行主从切换，但如果满足了quorum确定的票数，就能确定主库客观下线（如quorum = 1）。
3.  1. 思考问题1：假设有一个 Redis 集群，是“一主四从”，同时配置了包含 5 个哨兵实例的集群，quorum 值设为 2。在运行过程中，如果有 3 个哨兵实例都发生故障了，此时，Redis 主库如果有故障，还能正确地判断主库“客观下线”吗
      * 答：三个挂了省俩，能满足quorum 两票，但选举成为leader需要超过半数 为3票，所以无法进行主从切换。 
    2. 思考问题2： 哨兵实例是不是越多越好？
       * 答：不是，多的话需要增大哨兵之间通信，同时增加节点，增加故障风险
    3. 思考问题3：调大donw—after-millisecond（多久没回复哨兵确定主库主观下线）对减少误判有没有好处
      * 答：有好处，但调大也意味着主从切换需要更久时间，需要权衡。

## 补充
投票选举过程的细节并不是大家认为的：每个哨兵各自1票，这个情况是不一定的。下面具体说一下：

场景a：哨兵A先判定主库“主观下线”，然后马上询问哨兵B（注意，此时哨兵B只是被动接受询问，并没有去询问哨兵A，也就是它还没有进入判定“客观下线”的流程），哨兵B回复主库已“主观下线”，达到quorum=2后哨兵A此时可以判定主库“客观下线”。此时，哨兵A马上可以向其他哨兵发起成为“哨兵领导者”的投票，哨兵B收到投票请求后，由于自己还没有询问哨兵A进入判定“客观下线”的流程，所以哨兵B是可以给哨兵A投票确认的，这样哨兵A就已经拿到2票了。等稍后哨兵B也判定“主观下线”后想成为领导者时，因为它已经给别人投过票了，所以这一轮自己就不能再成为领导者了。

* 总结成一句话，当一个哨兵完成主库客观下线流程时，很大概率会直接发起投票选举leader， 其他哨兵只是完成了主观下线还没进行客观下线流程，所以其他哨兵手中的票只能投给那个发起者，等到了自己完成客观下线流程发起选举时，手中没票了，所以这轮无法给自己投票。

